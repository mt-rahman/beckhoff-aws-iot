<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4024.6">
  <POU Name="Buffer_Data" Id="{cc02954f-a949-4289-a7a3-7d2c4eb6e01e}" SpecialFunc="None">
    <Declaration><![CDATA[PROGRAM Buffer_Data
VAR
	pSec		: WORD;
	diff		: BOOL;
	
	TimeStr				: STRING;
	Trailer_ID_Lead		: STRING;
	Trailer_ID_Rear		: STRING;
	Lat					: STRING;
	Lon					: STRING;
	Speed				: STRING;
	Overspeed			: STRING;
	Payload_Lead		: STRING;
	Payload_Rear		: STRING;
	Overload_Lead		: STRING;
	Overload_Rear		: STRING;
	Pressure_Lead		: STRING;
	Pressure_Rear		: STRING;
	Overpressure_Lead	: STRING;
	Overpressure_Rear	: STRING;
	EventCode			: STRING;
	
	fbSqlDatabase	: FB_SQLDatabaseEvt(sNetID := '', tTimeout := T#5S);
	fbSqlCommand	: FB_SQLCommandEvt(sNetID := '', tTimeout := T#5S);
	fbSqlResult		: FB_SQLResultEvt(sNetID:='', tTimeout   := T#5S); 
	sCmd			: STRING(10000);
	sCmd2			: STRING(10000);
	nState			: INT;
	
	Buffer_Done		: BOOL;
	Done			: BOOL;
	 
END_VAR
]]></Declaration>
    <Implementation>
      <ST><![CDATA[(* convert to strings *)
IF GVL.Lead_Trailer_State = 8 OR GVL.Lead_Trailer_State = 17416 THEN
	Trailer_ID_Lead		:= UINT_TO_STRING(Read_ID.Trailer_ID_Lead);
	Payload_Lead		:= REAL_TO_STRING(Read_Payload.Payload_Lead);
	Overload_Lead		:= BOOL_TO_STRING(Read_Payload.Overload_Lead);
	Pressure_Lead		:= REAL_TO_STRING(Read_Pressure.Pressure_Lead);
	Overpressure_Lead	:= BOOL_TO_STRING(Read_Pressure.Overpressure_Lead);
ELSE
	Trailer_ID_Lead		:= '99';
	Payload_Lead		:= '0';
	Overload_Lead		:= 'FALSE';
	Pressure_Lead		:= '0';
	Overpressure_Lead	:= 'FALSE';	
END_IF

IF GVL.Rear_Trailer_State = 8 THEN
	Trailer_ID_Rear		:= UINT_TO_STRING(Read_ID.Trailer_ID_Rear);
	Payload_Rear		:= REAL_TO_STRING(Read_Payload.Payload_Rear);
	Overload_Rear		:= BOOL_TO_STRING(Read_Payload.Overload_Rear);
	Pressure_Rear		:= REAL_TO_STRING(Read_Pressure.Pressure_Rear);
	Overpressure_Rear	:= BOOL_TO_STRING(Read_Pressure.Overpressure_Rear);
ELSE
	Trailer_ID_Rear		:= '99';
	Payload_Rear		:= '0';
	Overload_Rear		:= 'FALSE';
	Pressure_Rear		:= '0';
	Overpressure_Rear	:= 'FALSE';
END_IF

TimeStr				:= Main_Read.TimeStr;
TimeStr				:= REPLACE(TimeStr, ' ', 1, 11);
Lat					:= REAL_TO_STRING(Read_GPS.Lat);
Lon					:= REAL_TO_STRING(Read_GPS.Lon);
Speed				:= REAL_TO_STRING(Read_GPS.Speed);
Overspeed			:= BOOL_TO_STRING(Read_GPS.Overspeed);

IF Read_FatigueCam.New_Event THEN
	Buffer_Done := FALSE;
END_IF
EventCode			:= Read_FatigueCam.EventCode;

(* save data to buffer every second *)
IF diff:= Background_Time.cSec <> pSec THEN

	IF Done THEN
		nState 	:= 0;
		Done	:= FALSE;	
	END_IF
	
	
	(* connect to localdb *)
	IF NOT fbSqlDatabase.bConnected THEN
		fbSqlDatabase.Connect(1);
	ELSE
	
		CASE nState OF
				
			0:
				IF fbSqlDatabase.CreateCmd(ADR(fbSqlCommand)) THEN
					IF fbSqlDatabase.bError THEN
						nState := 255; 
					ELSE
						nState := nState+1; 
					END_IF
				END_IF
				
			1:	
				(* build query *)	
				sCmd:= 'INSERT INTO buffer_data (datetime,trailer_id_lead,trailer_id_rear,latitude,longitude,speed,overspeed,payload_lead,payload_rear,overload_lead,overload_rear,pressure_lead,pressure_rear,overpressure_lead,overpressure_rear,event_code) VALUES ($'';
				sCmd2:= TimeStr;
				sCmd2:= CONCAT(sCmd2, '$',');
				sCmd2:= CONCAT(sCmd2, Trailer_ID_Lead);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Trailer_ID_Rear);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Lat);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Lon);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Speed);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Overspeed);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Payload_Lead);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Payload_Rear);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Overload_Lead);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Overload_Rear);
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Pressure_Lead); 
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Pressure_Rear); 
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Overpressure_Lead); 
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, Overpressure_Rear); 
				sCmd2:= CONCAT(sCmd2, ',');
				sCmd2:= CONCAT(sCmd2, EventCode);
				sCmd2:= CONCAT(sCmd2, ')');
				CONCAT2(ADR(sCmd), ADR(sCmd2), ADR(sCmd), SIZEOF(sCmd));
				
				IF fbSQLCommand.Execute(ADR(sCmd), SIZEOF(sCmd)) THEN
					IF fbSQLCommand.bError THEN
						nState := 255; 
					ELSE
						nState := nState+1; 
						pSec := Background_Time.cSec;
						
					END_IF
				END_IF
				
			2: 
				Done		:= TRUE;	
				
			255:
				nState := 0;
	
		END_CASE
	
	END_IF

END_IF
]]></ST>
    </Implementation>
    <LineIds Name="Buffer_Data">
      <LineId Id="722" Count="0" />
      <LineId Id="935" Count="1" />
      <LineId Id="938" Count="4" />
      <LineId Id="945" Count="3" />
      <LineId Id="944" Count="0" />
      <LineId Id="943" Count="0" />
      <LineId Id="950" Count="0" />
      <LineId Id="949" Count="0" />
      <LineId Id="951" Count="0" />
      <LineId Id="954" Count="2" />
      <LineId Id="953" Count="0" />
      <LineId Id="957" Count="0" />
      <LineId Id="962" Count="0" />
      <LineId Id="959" Count="2" />
      <LineId Id="958" Count="0" />
      <LineId Id="952" Count="0" />
      <LineId Id="934" Count="0" />
      <LineId Id="723" Count="0" />
      <LineId Id="893" Count="0" />
      <LineId Id="725" Count="3" />
      <LineId Id="1019" Count="0" />
      <LineId Id="1018" Count="0" />
      <LineId Id="1020" Count="2" />
      <LineId Id="739" Count="32" />
      <LineId Id="859" Count="1" />
      <LineId Id="772" Count="13" />
      <LineId Id="861" Count="1" />
      <LineId Id="786" Count="3" />
      <LineId Id="895" Count="2" />
      <LineId Id="894" Count="0" />
      <LineId Id="794" Count="0" />
      <LineId Id="799" Count="14" />
      <LineId Id="1025" Count="0" />
      <LineId Id="815" Count="7" />
      <LineId Id="140" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>